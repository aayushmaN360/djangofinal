{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-9">
        <!-- Post Display Card -->
        <div class="card shadow-sm mb-4">
            {% if post.photo %}
                <img src="{{ post.photo.url }}" class="card-img-top" alt="{{ post.title }}" style="max-height: 450px; object-fit: cover;">
            {% endif %}
            <div class="card-body p-4 p-md-5">
                <h1 class="card-title display-5">{{ post.title }}</h1>
                <p class="text-muted">
                    By <a href="{% url 'profile_page' post.author.username %}">{{ post.author.username }}</a> on {{ post.created_at|date:"F d, Y" }}
                    <span class="badge bg-secondary ms-2">{{ post.genre.name|default:"Uncategorized" }}</span>
                </p>
                {% if user == post.author %}
                    <div class="mb-3">
                        <a href="{% url 'post_update' post.pk %}" class="btn btn-sm btn-secondary">Edit Post</a>
                        <a href="{% url 'post_delete' post.pk %}" class="btn btn-sm btn-danger">Delete Post</a>
                    </div>
                {% endif %}
                <hr>
                <div class="post-content fs-5 mt-4">
                    {{ post.content|safe }}
                </div>
            </div>
        </div>

        <!-- Comments Section Card -->
        <div class="card shadow-sm">
            <div class="card-body p-4 p-md-5">
                <h3 class="mb-4">Discussion ({{ post.comments.count }})</h4>
                
                {% if user.is_authenticated %}
                    {% include "blog/includes/comment_form.html" %}
                {% else %}
                    <div class="alert alert-light border">
                        You must be <a href="{% url 'login' %}?next={{ request.path }}">logged in</a> to post a comment.
                    </div>
                {% endif %}
                
                <hr class="my-4">

                <div class="comment-list">
                    {% for comment in comments %}
                        {% if not comment.parent %}
                            {% include "blog/includes/comment.html" with comment=comment %}
                        {% endif %}
                    {% empty %}
                        <p class="text-muted">No comments yet. Be the first to start the discussion!</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascript %}
    <!-- Your existing JavaScript for comment replies -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const replyButtons = document.querySelectorAll('.reply-btn');
            const parentIdInput = document.getElementById('id_parent_id');
            const commentFormLabel = document.getElementById('comment-form-label');
            const commentForm = document.getElementById('comment-form');
            const cancelReplyBtn = document.getElementById('cancel-reply-btn');
            const topLevelFormContainer = document.getElementById('top-level-form-container');

            replyButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const commentId = this.getAttribute('data-comment-id');
                    const authorUsername = this.getAttribute('data-author');
                    parentIdInput.value = commentId;
                    commentFormLabel.innerHTML = `Replying to <strong>${authorUsername}</strong>`;
                    cancelReplyBtn.classList.remove('d-none');
                    const commentElement = document.getElementById(`comment-${commentId}`);
                    commentElement.after(commentForm);
                    commentForm.querySelector('textarea').focus();
                });
            });

            cancelReplyBtn.addEventListener('click', function() {
                parentIdInput.value = '';
                commentFormLabel.innerHTML = 'Add Your Comment';
                topLevelFormContainer.prepend(commentForm);
                this.classList.add('d-none');
            });
        });
    </script>
    
    <!-- ======================================================= -->
    <!-- NEW SCRIPT BLOCK FOR THE LIVE WORD COUNTER                -->
    <!-- ======================================================= -->
    <script>
        // Wait for the DOM to be fully loaded
        document.addEventListener("DOMContentLoaded", function() {
            // Find the textarea and the display element inside the comment form
            const commentTextarea = document.querySelector("#comment-form textarea");
            const wordCountDisplay = document.getElementById("word-count");
            const wordLimit = 100; // Your word limit

            // Make sure the elements actually exist on the page before adding listeners
            if (commentTextarea && wordCountDisplay) {
                // Add an event listener that fires every time the user types
                commentTextarea.addEventListener("keyup", function() {
                    // Get the text, remove leading/trailing whitespace
                    const text = this.value.trim();
                    
                    // Split by any sequence of whitespace to count words accurately
                    const words = text.split(/\s+/).filter(word => word.length > 0);
                    const currentWordCount = (text === '') ? 0 : words.length;

                    // Update the display text
                    wordCountDisplay.textContent = `${currentWordCount} / ${wordLimit} words`;

                    // Change color to red if the user goes over the limit
                    if (currentWordCount > wordLimit) {
                        wordCountDisplay.classList.remove('text-muted');
                        wordCountDisplay.classList.add('text-danger');
                    } else {
                        wordCountDisplay.classList.remove('text-danger');
                        wordCountDisplay.classList.add('text-muted');
                    }
                });
            }
        });
    </script>
    <!-- ======================================================= -->

{% endblock javascript %}